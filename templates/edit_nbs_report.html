{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Edit NBS Daily Report</h4>
        <h6>Editing report for {{ report.report_date.strftime('%d/%m/%y') }}</h6>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category=='error' else 'success' }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="/edit-nbs-report/{{ report.id }}">
          <div class="row">
            <div class="col-md-6">
              <label>Date <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="report_date" name="report_date"
                     value="{{ report.report_date.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="col-md-6">
              <label>Restaurant <span class="text-danger">*</span></label>
              {% if user.role != 'admin' %}
              <input type="text" class="form-control" value="{{ report.restaurant_name }}" disabled>
              <input type="hidden" name="restaurant_id" value="{{ report.restaurant_id }}">
              <input type="hidden" id="restaurant_id" value="{{ report.restaurant_id }}">
              {% else %}
              <select class="form-control" id="restaurant_id" name="restaurant_id" required>
                <option value="">Select Branch</option>
                {% for r in restaurants %}
                <option value="{{ r.id }}" {% if r.id == report.restaurant_id %}selected{% endif %}>
                  {{ r.restaurantname }}
                </option>
                {% endfor %}
              </select>
              {% endif %}
            </div>
          </div>

          <hr>
          <h5>Income Section</h5>
          <div class="row">
            <div class="col-md-4">
              <label>PetPooja Total</label>
              <input type="number" step="0.01" class="form-control calc-input" id="petpooja_total" name="petpooja_total"
                     value="{{ report.petpooja_total }}">
            </div>
            <div class="col-md-4">
              <label>NS Total</label>
              <input type="number" step="0.01" class="form-control calc-input" id="ns_total" name="ns_total"
                     value="{{ report.ns_total }}">
            </div>
            <div class="col-md-4">
              <label>Outdoor Catering (Pre-Booking Paid Today)</label>
              <input type="number" step="0.01" class="form-control" id="outdoor_catering_display"
                     value="{{ report.outdoor_catering }}" {% if user.role != 'admin' %}disabled{% endif %}>
              <input type="hidden" class="calc-input" name="outdoor_catering" id="outdoor_catering"
                     value="{{ report.outdoor_catering }}">
            </div>
          </div>

          <hr>
          <h5>Payment Methods</h5>
          <div class="row">
            <div class="col-md-4">
              <label>UPI</label>
              <input type="number" step="0.01" class="form-control calc-input" id="upi" name="upi"
                     value="{{ report.upi }}">
            </div>
            <div class="col-md-4">
              <label>Cash</label>
              <input type="number" step="0.01" class="form-control calc-input" id="cash" name="cash"
                     value="{{ report.cash }}">
            </div>
            <div class="col-md-4">
              <label>Misc Expense</label>
              <input type="number" step="0.01" class="form-control" id="r_expense_display"
                     value="{{ report.r_expense }}" disabled>
              <input type="hidden" class="calc-input" name="r_expense" id="r_expense"
                     value="{{ report.r_expense }}">
            </div>
          </div>

          <hr>
          <h5>Online Platforms</h5>
          <div class="row">
            <div class="col-md-6">
              <label>Swiggy</label>
              <input type="number" step="0.01" class="form-control calc-input" id="swiggy" name="swiggy"
                     value="{{ report.swiggy }}">
            </div>
            <div class="col-md-6">
              <label>Zomato</label>
              <input type="number" step="0.01" class="form-control calc-input" id="zomato" name="zomato"
                     value="{{ report.zomato }}">
            </div>
          </div>

          <hr>
          <h5>Live Calculation Summary</h5>
          <div class="row">
            <div class="col-md-4">
              <label>Net Sales</label>
              <input type="text" class="form-control" id="net_sales" value="{{ report.net_sales }}" readonly>
            </div>
            <div class="col-md-4">
              <label>Net Counter</label>
              <input type="text" class="form-control" id="net_counter" value="{{ report.net_counter }}" readonly>
            </div>
            <div class="col-md-4">
              <label>Difference</label>
              <input type="text" class="form-control" id="difference" value="{{ report.difference }}" readonly>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary">Update Report</button>
            <a href="{{ url_for('nbs_reports') }}" class="btn btn-secondary ms-2">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-fetch Misc Expense + Pre-Booking Paid Amount
function updateAutoFields() {
  const branchId = document.getElementById('restaurant_id')?.value || {{ report.restaurant_id }};
  const reportDate = document.getElementById('report_date').value;

  if (!branchId || !reportDate) {
    document.getElementById('r_expense').value = 0;
    document.getElementById('r_expense_display').value = 0;
    document.getElementById('outdoor_catering').value = 0;
    document.getElementById('outdoor_catering_display').value = 0;
    calculateLive();
    return;
  }

  Promise.all([
    fetch(`/fetch-misc-expense?restaurant_id=${branchId}&report_date=${reportDate}`).then(r => r.json()),
    fetch(`/fetch-prebooking-paid-today?restaurant_id=${branchId}&report_date=${reportDate}`).then(r => r.json())
  ])
  .then(([miscData, prebookData]) => {
    const misc = parseFloat(miscData.total_misc || 0).toFixed(2);
    const prebook = parseFloat(prebookData.total_prebooking_paid || 0).toFixed(2);

    document.getElementById('r_expense').value = misc;
    document.getElementById('r_expense_display').value = misc;

    document.getElementById('outdoor_catering').value = prebook;
    document.getElementById('outdoor_catering_display').value = prebook;

    calculateLive();
  })
  .catch(err => {
    console.error("Fetch error:", err);
    // Keep current values on error
    calculateLive();
  });
}

// Trigger on date or branch change
document.getElementById('report_date').addEventListener('change', updateAutoFields);
{% if user.role == 'admin' %}
document.getElementById('restaurant_id').addEventListener('change', updateAutoFields);
{% endif %}

// Initial load
updateAutoFields();

// Live calculation
function parseNum(id) {
  const el = document.getElementById(id);
  return el ? (parseFloat(el.value) || 0) : 0;
}

function calculateLive() {
  const petpooja = parseNum('petpooja_total');
  const ns_total = parseNum('ns_total');
  const outdoor = parseNum('outdoor_catering');
  const total_income = petpooja + ns_total + outdoor;

  const upi = parseNum('upi');
  const cash = parseNum('cash');
  const r_expense = parseNum('r_expense');
  const swiggy = parseNum('swiggy');
  const zomato = parseNum('zomato');

  const net_sales = total_income;
  const net_counter = upi + cash + r_expense + swiggy + zomato;
  const difference = net_counter - net_sales;

  document.getElementById('net_sales').value = net_sales.toFixed(2);
  document.getElementById('net_counter').value = net_counter.toFixed(2);

  const diffEl = document.getElementById('difference');
  diffEl.value = difference.toFixed(2);
  diffEl.classList.remove('text-success', 'text-danger');
  diffEl.classList.add(difference < 0 ? 'text-danger' : 'text-success');
}

// Re-calculate when user types
document.querySelectorAll('.calc-input').forEach(input => {
  input.addEventListener('input', calculateLive);
});

// Run once on load
calculateLive();
</script>
{% endblock %}