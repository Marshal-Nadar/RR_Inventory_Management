{% extends 'base.html' %}

{% block content %}
<style>
  .negative-value {
    color: #dc3545;
  }

  .positive-value {
    color: #28a745;
  }
</style>

<div class="page-wrapper">
  <div class="content">
    <div class="page-header d-flex justify-content-between align-items-center">
      <div class="page-title">
        <h4>NBS Daily Reports</h4>
      </div>
      <div class="page-btn d-flex gap-2">
        <a href="/add-nbs-report" class="btn btn-added">
          <i class="fas fa-plus me-1"></i>Add New Report
        </a>
        <button onclick="printNBSReports()" class="btn btn-info">
          <i class="fas fa-print me-1"></i>Print Reports
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <form method="get" action="/nbs-reports" class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="restaurant_id" class="form-label">Restaurant</label>

            {% if user.role in ['admin', 'store_manager'] %}
            <!-- Admin can select any restaurant -->
            <select id="restaurant_id" name="restaurant_id" class="form-select">
              <option value="">All Restaurants</option>
              {% for r in restaurants %}
              <option value="{{ r.id }}" {% if selected_restaurant==r.id|string %}selected{% endif %}>
                {{ r.restaurantname }}
              </option>
              {% endfor %}
            </select>

            {% else %}
            <!-- Non-admin users: restaurant fixed and disabled -->
            <select id="restaurant_id" name="restaurant_id" class="form-select" disabled>
              {% for r in restaurants %}
              {% if r.id == selected_restaurant|int %}
              <option value="{{ r.id }}" selected>{{ r.restaurantname }}</option>
              {% endif %}
              {% endfor %}
            </select>
            <!-- Hidden input to still send restaurant_id in GET -->
            <input type="hidden" name="restaurant_id" value="{{ selected_restaurant }}">
            {% endif %}
          </div>

          <div class="col-md-3">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date or '' }}">
          </div>

          <div class="col-md-3">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date or '' }}">
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-filter me-1"></i> Filter
            </button>
          </div>
        </form>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Restaurant</th>
                <th>Swiggy</th>
                <th>Zomato</th>
                <th style="width: 10%;">Total Income (PP + NS + OD)</th>
                <th>Net Counter</th>
                <th>Net Sales</th>
                <th>Difference</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for report in reports %}
              <tr>
                <td>{{ report.report_date.strftime('%d/%m/%y') }}</td>
                <td>{{ report.restaurantname }}</td>
                <td>{{ report.swiggy or 0 }}</td>
                <td>{{ report.zomato or 0 }}</td>
                <td>{{ "%.2f"|format(report.total_income) }}</td>
                <td>{{ "%.2f"|format(report.net_counter) }}</td>
                <td>{{ "%.2f"|format(report.net_petpooja) }}</td>
                <td>
                  <span class="{% if report.difference < 0 %}negative-value{% else %}positive-value{% endif %}">
                    {{ "%.2f"|format(report.difference) }}
                  </span>
                </td>
                <td>
                  <a href="/view-nbs-report/{{ report.id }}" class="btn btn-sm btn-info">
                    <i class="fas fa-eye"></i>
                  </a>
                  {% if user.role == 'admin' %}
                  <a href="/edit-nbs-report/{{ report.id }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="/delete-nbs-report/{{ report.id }}" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure you want to delete this report?')">
                    <i class="fas fa-trash"></i>
                  </a>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="text-center">No reports found</td>
              </tr>
              {% endfor %}
            </tbody>

            <tfoot>
              <tr style="font-weight: bold;">
                <td colspan="2">Total</td>
                <td>{{ "%.2f"|format(totals.total_swiggy) }}</td> <!-- Swiggy total -->
                <td>{{ "%.2f"|format(totals.total_zomato) }}</td> <!-- Zomato total -->
                <td>{{ "%.2f"|format(totals.total_income) }}</td>
                <td>{{ "%.2f"|format(totals.net_counter) }}</td>
                <td>{{ "%.2f"|format(totals.net_sales) }}</td>
                <td>{{ "%.2f"|format(totals.difference) }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
          <div class="d-flex justify-content-center mt-3">
            <nav>
              <ul class="pagination">
                {% if page > 1 %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page-1 }}{% if selected_restaurant %}&restaurant_id={{ selected_restaurant }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">Previous</a>
                </li>
                {% endif %}

                {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                  <a class="page-link" href="?page={{ p }}{% if selected_restaurant %}&restaurant_id={{ selected_restaurant }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                    {{ p }}
                  </a>
                </li>
                {% endfor %}

                {% if page < total_pages %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page+1 }}{% if selected_restaurant %}&restaurant_id={{ selected_restaurant }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function printNBSReports() {
    const currentUrl = window.location.href.split('?')[0];

    // Clone the table to modify for print
    const tableClone = document.querySelector('.table-responsive table').cloneNode(true);

    // Remove last column (Actions) from header
    tableClone.querySelectorAll('thead tr th:last-child, tfoot tr td:last-child').forEach(el => el.remove());

    // Remove last column from each body row
    tableClone.querySelectorAll('tbody tr').forEach(row => row.querySelector('td:last-child').remove());

    const tableHTML = tableClone.outerHTML;

    const printContent = `
       <!DOCTYPE html>
      <html>
      <head>
        <title>NBS Daily Reports</title>
        <style>
          body { margin: 0; font-family: Arial, sans-serif; }
          .company-info { text-align: center; margin-bottom: 20px; }
          .report-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
          .report-header h3 { margin: 0; font-size: 18px; padding-bottom: 2px; }
          .contact-info { text-align: right; font-size: 14px; line-height: 1.4; }
          .contact-info p { margin: 0; }
          table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; border: 2px solid #000; }
          th, td { padding: 10px; border: 1px solid #000; font-size: 12px; word-wrap: break-word; word-break: break-word; text-align: center; }
          tfoot td { font-weight: bold; background-color: #f2f2f2; }
          .negative-value { color: #dc3545; }
          .positive-value { color: #28a745; }
          .signatures { margin-top: 60px; display: flex; justify-content: flex-start; }
          .signatures p { margin: 0 20px 0 0; }
          @media print {
            .btn, .page-btn { display: none; }
          }
        </style>
      </head>
      <body>
        <div class="company-info">
          <h2>Dharani Inventory Solution</h2>
        </div>
        <div class="report-header">
          <h3>NBS DAILY REPORTS</h3>
          <div class="contact-info">
            <p>Date: ${new Date().toLocaleDateString()}</p>
          </div>
        </div>
        <div>${tableHTML}</div>
        <div class="signatures">
          <p>Authorized Signature: __________</p>
        </div>
      </body>
      </html>
    `;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'absolute';
    iframe.style.width = '0px';
    iframe.style.height = '0px';
    iframe.style.border = 'none';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(printContent);
    doc.close();

    iframe.contentWindow.focus();
    setTimeout(() => {
      iframe.contentWindow.print();
      document.body.removeChild(iframe);
    }, 200);
  }
</script>
{% endblock %}