{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Raw Material Transfer List by Date Range & Destination</h4>
        <h6>Filter transfers by date range and destination</h6>
      </div>
      {% if user.role=='admin' or user.role=='store_manager' or user.role=='branch_manager' %}
      <div class="page-btn">
        <a href="/transfer_raw_material" class="btn btn-added">
          <img src="../static/img/icons/plus.svg" alt="img">Transfer Raw Material
        </a>
      </div>
      {% endif %}
    </div>
    <form method="POST" action="/list_rawmaterial_transfers_range">
      <div class="row align-items-end mb-3">
        <div class="col-md-2">
          <label>From Date</label>
          <input type="date" name="from_date" class="form-control" value="{{ from_date if from_date else '' }}"
            required>
        </div>
        <div class="col-md-2">
          <label>To Date</label>
          <input type="date" name="to_date" class="form-control" value="{{ to_date if to_date else '' }}" required>
        </div>
        <div class="col-md-3">
          <label>Destination Type</label>
          <select name="destination_type" class="form-control" id="destination_type" required>
            <option value="" disabled {% if not destination_type %}selected{% endif %}>Select Destination Type</option>
            <option value="kitchen" {% if destination_type=='kitchen' %}selected{% endif %}>Kitchen</option>
            <option value="restaurant" {% if destination_type=='restaurant' %}selected{% endif %}>Restaurant</option>
          </select>
        </div>
        <div class="col-md-3">
          <label>Destination Name</label>
          <select name="destination_name" class="form-control" id="destination_name" required>
            <option value="" disabled {% if not destination_name %}selected{% endif %}>Select Destination</option>
          </select>
        </div>
        <div class="col-md-2 d-flex">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
      </div>

      <div class="table-responsive">
        {% if range_transfers %}
        <table class="table datanew" id="transferTable">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Raw Material</th>
              <th>Quantity</th>
              <th>Metric</th>
              <th>Transferred From</th>
              <th>Destination Type</th>
              <th>Transferred To</th>
              <th>Transferred On</th>
              <th>Transfer Avg</th>
              <th>Total Cost</th>
            </tr>
          </thead>
          <tbody>
            {% for transfer in range_transfers %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ transfer['raw_material_name'] }}</td>
              <td>{{ "%.2f"|format(transfer['quantity']) }}</td>
              <td>{{ transfer['metric'] }}</td>
              <td>{{ transfer['transferred_from'] }}</td>
              <td>{{ transfer['destination_type']|capitalize }}</td>
              <td>{{ transfer['transferred_to'] }}</td>
              <td>{{ transfer['transferred_date'] }}</td>
              <td>{{ "%.2f"|format(transfer['transfer_avg']) }}</td>
              <td>{{ "%.2f"|format(transfer['total_cost']) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th colspan="9" class="text-end">Grand Total Cost</th>
              <th id="grandCost">{{ "%.2f"|format(grand_total_cost) }}</th>
            </tr>
          </tfoot>
          <div class="total-summary mb-3 d-flex justify-content-between flex-row-reverse align-items-center">
            <div>
              <div class="total-cost-card bg-lightgreen p-3 rounded">
                <h5 class="mb-0">
                  <i class="fas fa-calculator me-2"></i>
                  Grand Cost: <span class="fw-bold" id="grandCostCard">₹{{ "%.2f"|format(grand_total_cost) }}</span>
                </h5>
              </div>
            </div>
            <button type="button" id="printButton" class="btn btn-secondary px-5 py-2">Print</button>
          </div>
        </table>
        {% else %}
        <p>No data available for the selected date range and destination.</p>
        {% endif %}
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="../static/plugins/select2/js/select2.min.js"></script>
<script src="../static/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="../static/plugins/sweetalert/sweetalerts.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const destinationTypeSelect = document.getElementById('destination_type');
    const destinationNameSelect = document.getElementById('destination_name');
    const kitchens = {{ kitchens | tojson | safe
  }};
  const restaurants = {{ restaurants | tojson | safe }};

  function updateDestinationNameOptions() {
    const selectedType = destinationTypeSelect.value;
    let options = [];

    if (selectedType === 'kitchen') {
      options = kitchens;
    } else if (selectedType === 'restaurant') {
      options = restaurants;
    }

    destinationNameSelect.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.text = 'Select Destination';
    defaultOption.disabled = true;
    defaultOption.selected = true;
    defaultOption.value = "";
    destinationNameSelect.appendChild(defaultOption);

    options.forEach(option => {
      const newOption = document.createElement('option');
      newOption.value = option.id;
      newOption.textContent = option[`${selectedType}name`];
      destinationNameSelect.appendChild(newOption);
    });
  }

  destinationTypeSelect.addEventListener('change', updateDestinationNameOptions);
  updateDestinationNameOptions();
  });

  document.addEventListener('DOMContentLoaded', function () {
    const printButton = document.getElementById('printButton');

    function updateTotals() {
      let totalCost = 0;
      const table = $('#transferTable').dataTable().api();

      table.rows({ search: 'applied' }).every(function () {
        const rowData = this.data();
        const cost = parseFloat(rowData[9]) || 0; // Total Cost column (index 9)
        totalCost += cost;
      });

      document.getElementById('grandCost').textContent = totalCost.toFixed(2);
      document.getElementById('grandCostCard').textContent = '₹' + totalCost.toFixed(2);

      return { totalCost };
    }

    // Recalculate when DataTable is searched/drawn
    $('#transferTable').on('search.dt draw.dt', function () {
      updateTotals();
    });

    // Initial totals after table loads
    setTimeout(updateTotals, 100);

    // Print functionality
    printButton.addEventListener('click', function () {
      const table = $('#transferTable').dataTable().api();
      let allRows = table.rows({ search: 'applied' }).data();
      const { totalCost } = updateTotals();

      let rowsHtml = '';
      allRows.each(function (rowData, index) {
        rowsHtml += `
          <tr>
            <td style="padding: 6px; font-size: 10px;">${index + 1}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[1]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[2]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[3]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[4]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[5]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[6]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[7]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[8]}</td>
            <td style="padding: 6px; font-size: 10px;">${rowData[9]}</td>
          </tr>
        `;
      });

      const currentUrl = window.location.href.split('?')[0];

      const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>Raw Material Transfer Report</title>
  <style>
    @page {
      margin: 1cm;

      @top-right {
        content: "${new Date().toLocaleDateString('en-GB')}:${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}";
        font-size: 10pt;
      }

      @top-center {
        content: "Dharani Inventory Solution";
        font-size: 12pt;
        font-weight: bold;
      }

      @bottom-left {
        content: "${currentUrl}";
        font-size: 8pt;
      }

      @bottom-right {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 8pt;
      }
    }

    body {
      margin: 0;
    }

    .company-info {
      text-align: center;
      margin-bottom: 20px;
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 20px;
      width: 100%;
    }

    .report-header h3 {
      margin: 0;
      font-size: 18px;
      padding-bottom: 2px;
    }

    .contact-info {
      text-align: right;
      font-size: 14px;
      line-height: 1.4;
    }

    .contact-info p {
      margin: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      table-layout: fixed;
      margin-bottom: 20px;
    }

    th, td {
      padding: 6px;
      border: 1px solid #000;
      word-wrap: break-word;
      word-break: break-word;
      font-size: 10px;
      vertical-align: top;
      line-height: 1.2;
    }

    .total {
      text-align: right;
      margin-top: 20px;
    }

    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 60px;
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="company-info">
      <h2>{{ contact_details.name }}</h2>
    </div>
    <div class="report-header">
      <h3>Raw Material Transfer Report</h3>
      <div class="contact-info">
        <p><strong>Contact:</strong> {{ contact_details.contact_number }}</p>
        <p><strong>Address:</strong> {{ contact_details.address }}</p>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width: 3%;">#</th>
          <th style="width: 15%;">Raw Material</th>
          <th style="width: 8%;">Quantity</th>
          <th style="width: 7%;">Metric</th>
          <th style="width: 15%;">Transferred From</th>
          <th style="width: 12%;">Destination Type</th>
          <th style="width: 15%;">Transferred To</th>
          <th style="width: 12%;">Transferred On</th>
          <th style="width: 8%;">Transfer Avg</th>
          <th style="width: 8%;">Total Cost (₹)</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
    <div class="total">
      <h3>Grand Total Cost: ₹${totalCost.toFixed(2)}</h3>
    </div>
    <div class="signatures">
      <p>Authorized Signature: __________</p>
      <p>Receiver Signature: __________</p>
    </div>
  </div>
</body>
</html>
`;

      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.width = '0px';
      iframe.style.height = '0px';
      iframe.style.border = 'none';
      document.body.appendChild(iframe);

      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(printContent);
      doc.close();

      iframe.contentWindow.focus();
      iframe.contentWindow.print();

      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    });
  });
</script>
{% endblock %}