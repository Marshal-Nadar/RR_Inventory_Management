{% extends 'base.html' %} {% block content %}

<style>
  .nbs-report table {
    border: 2px solid #000;
    width: 100%;
    margin-top: 20px;
  }
  .nbs-report td {
    padding: 10px;
    border: 1px solid #000 !important;
    font-size: 14px;
    text-align: center;
  }
  .negative-value {
    color: #dc3545;
    font-weight: bold;
  }
  .positive-value {
    color: #28a745;
    font-weight: bold;
  }
  @media print {
    .page-header,
    .btn {
      display: none !important;
    }
    body {
      padding: 10px;
    }
  }
</style>

<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>
          NBS Daily Report - {{ report.report_date.strftime('%d/%m/%y') }}
        </h4>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="nbs-report">
          <!-- Header -->
          <table class="table table-bordered">
            <tr>
              <td style="border: none; width: 20%"></td>
              <td style="border: none">DATE:</td>
              <td style="border: none">
                <strong>{{ report.report_date.strftime('%d/%m/%y') }}</strong>
              </td>
              <td style="border: none"></td>
            </tr>
            <tr>
              <td style="border: none"></td>
              <td style="border: none">CASHIER:</td>
              <td style="border: none">
                <strong>{{ report.cashier_name }}</strong>
              </td>
              <td style="border: none"></td>
            </tr>
          </table>

          <!-- Main Table - EXACT SAME AS YOUR IMAGE -->
          <table class="table table-bordered">
            <tr>
              <td style="width: 25%"><strong>PETPOOJA</strong></td>
              <td style="width: 25%">
                {{ "%.2f"|format(report.petpooja_total) }}
              </td>
              <td style="width: 25%"><strong>UPI</strong></td>
              <td style="width: 25%">{{ "%.2f"|format(report.upi) }}</td>
            </tr>
            <tr>
              <td><strong>NS</strong></td>
              <td>{{ "%.2f"|format(report.ns_total) }}</td>
              <td><strong>CASH</strong></td>
              <td>{{ "%.2f"|format(report.cash) }}</td>
            </tr>
            <tr>
              <td><strong>OUTDOOR CATERING</strong></td>
              <td id="outdoor-cell">
                {{ "%.2f"|format(report.outdoor_catering) }}
              </td>
              <td><strong>Miscellaneous Expense</strong></td>
              <td id="misc-cell">{{ "%.2f"|format(report.r_expense) }}</td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td><strong>SWIGGY</strong></td>
              <td>{{ "%.2f"|format(report.swiggy) }}</td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td><strong>ZOMATO</strong></td>
              <td>{{ "%.2f"|format(report.zomato) }}</td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td><strong>NET COUNTER</strong></td>
              <td id="net-counter-main">
                <strong>{{ "%.2f"|format(report.net_counter) }}</strong>
              </td>
            </tr>
            <tr>
              <td><strong>NET SALES</strong></td>
              <td id="net-sales-main">
                <strong>{{ "%.2f"|format(report.net_petpooja) }}</strong>
              </td>
              <td colspan="2"></td>
            </tr>
          </table>

          <!-- Bottom Summary Table -->
          <table class="table table-bordered">
            <tr>
              <td style="width: 50%"><strong>NET COUNTER</strong></td>
              <td id="summary-counter">
                {{ "%.2f"|format(report.net_counter) }}
              </td>
            </tr>
            <tr>
              <td><strong>NET SALES</strong></td>
              <td id="summary-sales">
                {{ "%.2f"|format(report.net_petpooja) }}
              </td>
            </tr>
            <tr>
              <td><strong>DIFFERENCE</strong></td>
              <td id="summary-difference">
                <strong class="negative-value"
                  >{{ "%.2f"|format(report.difference) }}</strong
                >
              </td>
            </tr>
          </table>

          <div class="mt-4">
            <a href="{{ url_for('nbs_reports') }}" class="btn btn-secondary"
              >Back to List</a
            >
            {% if user.role == 'admin' %}
            <a href="/edit-nbs-report/{{ report.id }}" class="btn btn-primary"
              >Edit Report</a
            >
            {% endif %}
            <button onclick="printNBSReport()" class="btn btn-info">
              Print Report
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  const data = {
    petpooja: {{ report.petpooja_total|default(0) }},
    ns: {{ report.ns_total|default(0) }},
    upi: {{ report.upi|default(0) }},
    cash: {{ report.cash|default(0) }},
    swiggy: {{ report.swiggy|default(0) }},
    zomato: {{ report.zomato|default(0) }},
    rid: {{ report.restaurant_id }},
    date: "{{ report.report_date.strftime('%Y-%m-%d') }}"
  };

  let liveValues = null;

  async function loadLiveData() {
    try {
      const [miscRes, prebookRes] = await Promise.all([
        fetch(`/fetch-misc-expense?restaurant_id=${data.rid}&report_date=${data.date}`),
        fetch(`/fetch-prebooking-paid-today?restaurant_id=${data.rid}&report_date=${data.date}`)
      ]);
      const misc = await miscRes.json();
      const prebook = await prebookRes.json();

      const outdoor = parseFloat(prebook.total_prebooking_paid || 0);
      const miscExp = parseFloat(misc.total_misc || 0);
      const netSales = data.petpooja + data.ns + outdoor;
      const netCounter = data.upi + data.cash + miscExp + data.swiggy + data.zomato;
      const difference = netCounter - netSales;

      liveValues = { outdoor, miscExp, netSales, netCounter, difference };

      // Update screen too
      document.getElementById('outdoor-cell').textContent = outdoor.toFixed(2);
      document.getElementById('misc-cell').textContent = miscExp.toFixed(2);
      document.getElementById('net-counter-main').textContent = netCounter.toFixed(2);
      document.getElementById('net-sales-main').textContent = netSales.toFixed(2);
      document.getElementById('summary-counter').textContent = netCounter.toFixed(2);
      document.getElementById('summary-sales').textContent = netSales.toFixed(2);

      const diffEl = document.getElementById('summary-difference').querySelector('strong');
      diffEl.textContent = difference.toFixed(2);
      diffEl.className = difference < 0 ? 'negative-value' : 'positive-value';

    } catch (e) {
      console.log("Live data failed, will use screen values on print");
    }
  }

  loadLiveData();

  function printNBSReport() {
    // Wait a moment for live data
    setTimeout(() => {
      const outdoorValue = liveValues?.outdoor?.toFixed(2) || document.getElementById('outdoor-cell').textContent.trim();
      const miscValue    = liveValues?.miscExp?.toFixed(2) || document.getElementById('misc-cell').textContent.trim();
      const netCounter   = liveValues?.netCounter?.toFixed(2) || document.getElementById('net-counter-main').textContent.trim();
      const netSales     = liveValues?.netSales?.toFixed(2) || document.getElementById('net-sales-main').textContent.trim();
      const difference   = liveValues?.difference?.toFixed(2) ||
                          (parseFloat(netCounter) - parseFloat(netSales)).toFixed(2);

      const printContent = `<!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>NBS Daily Report</title>
    <style>
      @page {
        margin: 1cm;
        @top-right { content: "${new Date().toLocaleDateString("en-GB")} ${new Date().toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"})}"; font-size: 10pt; }
        @top-center { content: "Dharani Inventory Solution"; font-size: 12pt; font-weight: bold; }
        @bottom-left { content: "${window.location.href.split("?")[0]}"; font-size: 8pt; }
        @bottom-right { content: "Page " counter(page) " of " counter(pages); font-size: 8pt; }
      }
      body { margin: 0; font-family: Arial, sans-serif; padding: 20px; }
      .company-info { text-align: center; margin-bottom: 20px; }
      .report-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
      .report-header h3 { margin: 0; font-size: 18px; }
      .contact-info { text-align: right; font-size: 14px; line-height: 1.4; }
      .contact-info p { margin: 0; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 2px solid #000; }
      td { padding: 8px; border: 1px solid #000; text-align: center; font-size: 11px; }
      .bold { font-weight: bold; }
      .signatures { display: flex; justify-content: space-between; margin-top: 60px; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="company-info">
      <h2>Dharani Inventory Solution</h2>
    </div>
    <div class="report-header">
      <h3>NBS DAILY REPORT</h3>
      <div class="contact-info">
        <p><strong>Date:</strong> {{ report.report_date.strftime('%d/%m/%y') }}</p>
        <p><strong>Cashier:</strong> {{ report.cashier_name }}</p>
      </div>
    </div>

    <table>
      <tr>
        <td class="bold">PETPOOJA</td>
        <td>${data.petpooja.toFixed(2)}</td>
        <td class="bold">UPI</td>
        <td>${data.upi.toFixed(2)}</td>
      </tr>
      <tr>
        <td class="bold">NS</td>
        <td>${data.ns.toFixed(2)}</td>
        <td class="bold">CASH</td>
        <td>${data.cash.toFixed(2)}</td>
      </tr>
      <tr>
        <td class="bold">OUTDOOR CATERING</td>
        <td class="bold">${outdoorValue}</td>
        <td class="bold">Miscellaneous Expense</td>
        <td class="bold">${miscValue}</td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td class="bold">SWIGGY</td>
        <td>${data.swiggy.toFixed(2)}</td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td class="bold">ZOMATO</td>
        <td>${data.zomato.toFixed(2)}</td>
      </tr>
      <tr>
        <td></td>
        <td></td>
        <td class="bold">NET COUNTER</td>
        <td class="bold">${netCounter}</td>
      </tr>
      <tr>
        <td class="bold">NET SALES</td>
        <td class="bold">${netSales}</td>
        <td></td>
        <td></td>
      </tr>
    </table>

    <table>
      <tr>
        <td style="width:50%" class="bold">NET COUNTER</td>
        <td>${netCounter}</td>
      </tr>
      <tr>
        <td class="bold">NET SALES</td>
        <td>${netSales}</td>
      </tr>
      <tr>
        <td class="bold">DIFFERENCE</td>
        <td class="bold" style="color: ${parseFloat(difference) < 0 ? 'red' : 'green'}">${difference}</td>
      </tr>
    </table>

    <div class="signatures">
      <p>Authorized Signature: __________</p>
      <p>Cashier Signature: __________</p>
    </div>
  </body>
  </html>`;

      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }, 800);
  }
</script>
{% endblock %}
