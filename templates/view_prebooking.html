{% extends 'base.html' %}

{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Pre-Booking Details - {{ order.order_number }}</h4>
      </div>
    </div>

    <div class="row">
      <!-- Order Details -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <h5>Order Information</h5>
            <hr>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Order Number:</strong> {{ order.order_number }}</p>
                <p><strong>Customer Name:</strong> {{ order.username }}</p>
                <p><strong>Mobile:</strong> {{ order.mobile_number }}</p>
                <p><strong>Email:</strong> {{ order.email or 'N/A' }}</p>
                <p><strong>Branch:</strong> {{ order.restaurantname or 'N/A' }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Order Date:</strong> {{ order.created_at.strftime('%d/%m/%Y %I:%M %p') }}</p>
                <p><strong>Delivery Date:</strong> {{ order.delivery_date.strftime('%d/%m/%Y') }}</p>
                <p><strong>Delivery Time:</strong> 
  {% if order.delivery_time %}
    {{ (datetime.min + order.delivery_time).time().strftime('%I:%M %p') }}
  {% else %}
    N/A
  {% endif %}
</p>
                <p><strong>Order Status:</strong> 
                  <span class="badge badge-{{ order.order_status }}">{{ order.order_status|upper }}</span>
                </p>
                <p><strong>Payment Status:</strong> 
                  <span class="badge badge-{{ order.payment_status }}">{{ order.payment_status|upper }}</span>
                </p>
              </div>
            </div>

            <h5 class="mt-4">Delivery Address</h5>
            <hr>
            <p>{{ order.delivery_address }}</p>

            {% if order.notes %}
            <h5 class="mt-4">Notes</h5>
            <hr>
            <p>{{ order.notes }}</p>
            {% endif %}

            <h5 class="mt-4">Product Details</h5>
            <hr>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Unit Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ order.product_name }}</td>
                  <td>₹{{ "%.2f"|format(order.unit_price) }}</td>
                  <td>{{ order.quantity }}</td>
                  <td>₹{{ "%.2f"|format(order.total_amount) }}</td>
                </tr>
              </tbody>
            </table>

            <div class="mt-3">
              <a href="{{ url_for('prebooking_list') }}" class="btn btn-secondary">Back to List</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Summary -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5>Payment Summary</h5>
            <hr>
            <div class="d-flex justify-content-between mb-2">
              <strong>Total Amount:</strong>
              <span>₹{{ "%.2f"|format(order.total_amount) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <strong>Amount Paid:</strong>
              <span class="text-success">₹{{ "%.2f"|format(order.amount_paid) }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <strong>Pending Balance:</strong>
              <span class="text-danger">₹{{ "%.2f"|format(order.pending_balance) }}</span>
            </div>

            {% if order.pending_balance > 0 %}
            <hr>
            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
              Add Payment
            </button>
            {% endif %}
          </div>
        </div>

        <!-- Update Status Card -->
        {% if user.role in ['admin', 'store_manager', 'branch_manager'] %}
        <div class="card mt-3">
          <div class="card-body">
            <h5>Update Status</h5>
            <hr>
            <form method="POST" action="/update-order-status/{{ order.id }}">
              <div class="form-group">
                <label>Order Status</label>
                <select class="form-control" name="order_status" required>
                  <option value="pending" {% if order.order_status=='pending' %}selected{% endif %}>Pending</option>
                  <option value="confirmed" {% if order.order_status=='confirmed' %}selected{% endif %}>Confirmed</option>
                  <option value="preparing" {% if order.order_status=='preparing' %}selected{% endif %}>Preparing</option>
                  <option value="ready" {% if order.order_status=='ready' %}selected{% endif %}>Ready</option>
                  <option value="delivered" {% if order.order_status=='delivered' %}selected{% endif %}>Delivered</option>
                  <option value="cancelled" {% if order.order_status=='cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
              </div>
              <button type="submit" class="btn btn-success w-100 mt-2">Update Status</button>
            </form>
          </div>
        </div>
        {% endif %}

        <!-- Payment History -->
        {% if payments %}
        <div class="card mt-3">
          <div class="card-body">
            <h5>Payment History</h5>
            <hr>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Method</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in payments %}
                  <tr>
                    <td>{{ payment.payment_date.strftime('%d/%m/%y') }}</td>
                    <td>₹{{ "%.2f"|format(payment.amount) }}</td>
                    <td>{{ payment.payment_method|upper }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/add-payment/{{ order.id }}">
        <div class="modal-body">
          <div class="form-group">
            <label>Amount <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="amount" step="0.01" 
                   max="{{ order.pending_balance }}" required>
            <small class="text-muted">Pending Amount: ₹{{ "%.2f"|format(order.pending_balance) }}</small>
          </div>
          <div class="form-group mt-3">
            <label>Payment Method</label>
            <select class="form-control" name="payment_method">
              <option value="cash">Cash</option>
              <option value="upi">UPI</option>
              <option value="card">Card</option>
              <option value="online">Online</option>
            </select>
          </div>
          <div class="form-group mt-3">
            <label>Remarks</label>
            <textarea class="form-control" name="remarks" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .badge-pending { background-color: #ffc107; color: #000; }
  .badge-partial { background-color: #17a2b8; }
  .badge-completed { background-color: #28a745; }
  .badge-confirmed { background-color: #007bff; }
  .badge-preparing { background-color: #fd7e14; }
  .badge-ready { background-color: #20c997; }
  .badge-delivered { background-color: #6c757d; }
  .badge-cancelled { background-color: #dc3545; }
</style>
{% endblock %}