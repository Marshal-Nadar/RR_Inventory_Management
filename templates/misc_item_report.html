{% extends "base.html" %}

{% block content %}
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Miscellaneous Item Report</h4>
      </div>
    </div>

    <!-- Filter/Search Section -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" action="/misc_item_report">
          <div class="row">
            <div class="col-md-4">
              <label for="date_from">From Date</label>
              <input type="date" name="date_from" id="date_from" class="form-control"
                value="{{ request.args.get('date_from', '') }}">
            </div>
            <div class="col-md-4">
              <label for="date_to">To Date</label>
              <input type="date" name="date_to" id="date_to" class="form-control"
                value="{{ request.args.get('date_to', '') }}">
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-primary px-5">Filter</button>
            <a href="/misc_item_report" class="btn btn-secondary px-5">Reset</a>
            <button type="button" id="printButton" class="btn btn-secondary px-5" {% if not
              (request.args.get('date_from') and request.args.get('date_to') and misc_items) %}disabled{% endif %}>
              Print
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Table Section -->
    {% if request.args.get('date_from') and request.args.get('date_to') %}
    <div class="table-responsive">
      <table class="table datanew" id="miscTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Type of Expense</th>
            <th>Sub Category</th>
            <th>Branch</th>
            <th>Branch Manager</th>
            <th>Notes</th>
            <th>Cost</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% if misc_items %}
          {% for item in misc_items %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ item.type_of_expense or '-' }}</td>
            <td>{{ item.sub_category or '-' }}</td>
            <td>{{ item.branch_name or item.restaurant_id or '-' }}</td>
            <td>{{ item.branch_manager or '-' }}</td>
            <td class="notes-col">{{ item.notes or '-' }}</td>
            <td>{{ item.cost or '-' }}</td>
            <td>
              {% if item.manual_date %}
              {{ item.manual_date.strftime('%d-%m-%Y %I:%M:%S %p') }}
              {% elif item.created_at %}
              {{ item.created_at.strftime('%d-%m-%Y %I:%M:%S %p') }}
              {% else %}
              -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <!-- FIXED: Individual <td> elements instead of colspan="7" -->
          <tr>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">No records found</td>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">-</td>
            <td class="text-center text-muted">-</td>
          </tr>
          {% endif %}
        </tbody>
        <div class="total-summary mb-3">
          <div class="d-flex justify-content-between align-items-end">
            <div class="table-top">
              <div class="search-set">
                <div class="search-input">
                  <a class="btn btn-searchset">
                    <img src="../static/img/icons/search-white.svg" alt="img">
                  </a>
                </div>
              </div>
            </div>
            <div class="total-cost-card bg-lightgreen p-3 rounded">
              <h5 class="mb-0">
                <i class="fas fa-calculator me-2"></i>
                Grand Total:
                <span class="fw-bold">₹{{ "%.2f"|format(total_cost) }}</span>
              </h5>
            </div>
          </div>
        </div>
      </table>
    </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const printButton = document.getElementById('printButton');
    const totalCost = "{{ '%.2f' % total_cost }}";

    function updateGrandTotal() {
      let visibleTotal = 0;

      const table = $('#miscTable').dataTable().api();
      table.rows({ search: 'applied' }).every(function (rowIdx, tableLoop, rowLoop) {
        const rowData = this.data();
        const costValue = rowData[6]; // Cost is in column index 6

        if (costValue && costValue !== '-') {
          const numericCost = parseFloat(costValue.toString().replace(/[^\d.-]/g, ''));
          if (!isNaN(numericCost)) {
            visibleTotal += numericCost;
          }
        }
      });

      // Update the grand total display
      const grandTotalSpan = document.querySelector('.total-cost-card .fw-bold');
      if (grandTotalSpan) {
        grandTotalSpan.textContent = '₹' + visibleTotal.toFixed(2);
      }

      return visibleTotal;
    }

    // Listen for search events on DataTable
    $('#miscTable').on('search.dt', function () {
      updateGrandTotal();
    });

    $('#miscTable').on('draw.dt', function () {
      updateGrandTotal();
    });

    // Initial calculation for the default view
    setTimeout(updateGrandTotal, 100);

    printButton.addEventListener('click', function () {
      const table = $('#miscTable').dataTable().api();
      let allRows = table.rows({ search: 'applied' }).data();
      const currentUrl = window.location.href.split('?')[0];

      const printTotalCost = updateGrandTotal();

      // Add this helper function above your print code
      function formatDateDDMMYY(dateString) {
        if (!dateString) return null;

        const date = new Date(dateString);
        if (isNaN(date)) return dateString; // Return original if invalid date

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        return `${day}-${month}-${year}`;
      }

      let rowsHtml = '';
      allRows.each(function (rowData, index) {
        rowsHtml += `
        <tr>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${index + 1}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[1] || '-'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[2] || 'NA'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[3] || '-'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[4] || '-'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[5] || '-'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${rowData[6] || '-'}</td>
            <td style="padding: 6px; font-size: 10px; vertical-align: top;">${formatDateDDMMYY(rowData[7]) || '-'}</td>
        </tr>
    `;
      });

      const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Miscellaneous Item Report</title>
        <style>
            @page {
                margin: 1cm;
                @top-right {
                    content: "${new Date().toLocaleDateString('en-GB')}:${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}";
                    font-size: 10pt;
                }
                @top-center {
                    content: "Dharani Inventory Solution";
                    font-size: 12pt;
                    font-weight: bold;
                }
                @bottom-left {
                    content: "${currentUrl}";
                    font-size: 8pt;
                }
                @bottom-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 8pt;
                }
            }
            body { 
                margin: 0;
                // font-family: Arial, sans-serif;
            }
            .report-title {
                text-align: start;
            }
            .company-info {
                text-align: center;
                margin-bottom: 20px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                text-align: center;
                table-layout: fixed;
                margin-bottom: 20px;
            }
            th, td {
                padding: 6px;
                border: 1px solid #000;
                word-wrap: break-word;
                word-break: break-word;
                font-size: 10px;
                vertical-align: top;
                line-height: 1.2;
            }
            .total {
                text-align: right;
                margin-top: 20px;
            }
            .signatures {
                display: flex;
                justify-content: space-between;
                margin-top: 60px;
            }
            .main-content {
                margin-top: 0px;
            }
                
            .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;  /* Changed to align at bottom */
            margin-bottom: 20px;
            width: 100%;
        }
        
        .report-header h3 {
            margin: 0;
            font-size: 18px;
            padding-bottom: 2px; /* Optional: Add small padding if text appears too low */
        }
        
        .contact-info {
            text-align: right;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .contact-info p {
            margin: 0;
        }
        </style>
    </head>
    <body>
        <div class="main-content">
            <div class="company-info">
                <h2>{{ contact_details.name }}</h2>
            </div>

            <div class="report-header">
              <h3>Miscellaneous Item Report</h3>
              <div class="contact-info">
                <p><strong>Contact:</strong> {{ contact_details.contact_number }}</p>
                <p><strong>Address:</strong> {{ contact_details.address }}</p>
              </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 3%;">#</th>
                        <th style="width: 12%;">Type of Expense</th>
                        <th style="width: 10%;">Sub Category</th>
                        <th style="width: 16%;">Branch</th>
                        <th style="width: 12%;">Branch Manager</th>
                        <th style="width: 30%;">Notes</th>
                        <th style="width: 8%;">Cost (₹)</th>
                        <th style="width: 9%;">Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>

            <div class="total">
                <h3>Grand Total: ₹ ${printTotalCost.toFixed(2)}</h3>
            </div>

            <div class="signatures">
                <p>Authorized Signature: __________</p>
                <p>Receiver Signature: __________</p>
            </div>
        </div>
    </body>
    </html>
    `;

      const iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.width = '0px';
      iframe.style.height = '0px';
      iframe.style.border = 'none';
      document.body.appendChild(iframe);

      const doc = iframe.contentWindow.document;
      doc.open();
      doc.write(printContent);
      doc.close();

      // Add this event listener before printing
      iframe.contentWindow.onbeforeprint = function () {
        // This changes the print job name in most browsers
        document.title = "Miscellaneous Item Report";
      };

      iframe.contentWindow.focus();

      // For Chrome specifically
      // iframe.contentWindow.print();

      // Fallback for other browsers
      setTimeout(function () {
        iframe.contentWindow.document.title = "Miscellaneous Item Report";
        iframe.contentWindow.print();
      }, 200);

      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    });
  });
</script>
{% endblock %}