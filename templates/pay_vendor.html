{% extends 'base.html' %}
{% block content %}
<div class="page-wrapper">
    <div class="content">
        <div class="page-header">
            <div class="page-title">
                <h4>Add Vendor Payments</h4>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table datanew">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Vendor</th>
                                <th>Total Purchased Amount(Rs)</th>
                                <th>Total Amount Paid(Rs)</th>
                                <th>Total Due(Rs)</th>
                                <th>Pay Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in pending_payments_vendor_cumulative %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ payment['vendor_name'] }}</td>
                                <td class="currency" data-value="{{ payment['total_outstanding_cost'] }}">{{
                                    payment['total_outstanding_cost'] }}</td>
                                <td class="currency" data-value="{{ payment['total_paid'] }}">{{ payment['total_paid']
                                    }}</td>
                                <td class="currency" data-value="{{ payment['total_due'] }}">{{ payment['total_due'] }}
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-pay" data-vendor="{{ payment['vendor_name'] }}"
                                        data-vendor-id="{{ payment['vendor_id'] }}" data-toggle="modal"
                                        data-target="#payModal">
                                        Pay
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div><!-- Display flashed messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    <ul>
                        {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Payment -->
<div class="modal fade" id="payModal" tabindex="-1" role="dialog" aria-labelledby="payModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payModalLabel">Pay Amount</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>Vendor: <span id="vendorName"></span></h5>
                <form id="payForm">
                    <input type="hidden" id="vendorId" name="vendorId">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice Number</th>
                                    <th>Purchase Date</th>
                                    <th>Outstanding Cost(Rs)</th>
                                    <th>Pay Amount(Rs)</th>
                                    <th>Due(Rs)</th>
                                    <th>Mode of Payment</th>
                                    <th>Date of Payment</th>
                                </tr>
                            </thead>
                            <tbody id="paymentDetailsTable">
                                <!-- Dynamic rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="default-text">Submit</span>
                        <span class="processing-text" style="display: none;">Processing...</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const payButtons = document.querySelectorAll('.btn-pay');
        const vendorNameSpan = document.getElementById('vendorName');
        const vendorIdInput = document.getElementById('vendorId');
        const paymentDetailsTable = document.getElementById('paymentDetailsTable');
        const payForm = document.getElementById('payForm');
        const payModal = $('#payModal'); // jQuery modal reference

        function formatIndianCurrency(amount) {
            return new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }

        // Attach event listeners to "Pay" buttons
        payButtons.forEach(button => {
            button.addEventListener('click', async function () {
                const vendorName = this.getAttribute('data-vendor');
                const vendorId = this.getAttribute('data-vendor-id');

                // Populate modal fields
                vendorNameSpan.textContent = vendorName;
                vendorIdInput.value = vendorId;

                // Clear previous table rows
                paymentDetailsTable.innerHTML = '';

                try {
                    // Fetch payment details for the vendor
                    const response = await fetch(`/get_payment_details/${vendorId}`);
                    if (!response.ok) throw new Error('Failed to fetch payment details.');

                    const data = await response.json();

                    // Populate table with payment details
                    data.forEach(payment => {
                        const dueAmount = payment.total_due - (payment.pay_amount || 0);
                        const today = "{{ todays_date }}"

                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${payment.invoice_number}</td>
                        <td class="purchase-date">${payment.purchase_date}</td>
                        <td class="outstanding-cost">${formatIndianCurrency(payment.total_due)}</td>
                        <td>
                            <input type="number" class="form-control pay-amount" 
                                   data-payment-id="${payment.payment_id}"
                                   data-invoice-number="${payment.invoice_number}"
                                   value="0" 
                                   min="0" 
                                   max="${payment.total_due.toFixed(2)}"
                                   step="0.01">
                        </td>
                        <td class="due-amount">${formatIndianCurrency(dueAmount)}</td>
                        <td>
                            <select class="form-control mode-of-payment">
                                <option value="upi">UPI</option>
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </td>
                        <td>
                            <input type="date" class="form-control date-of-payment" value="${today}" readonly>
                        </td>
                    `;
                        paymentDetailsTable.appendChild(row);
                    });

                    // Attach event listener to each pay-amount input to update dueAmount and validate input
                    document.querySelectorAll('.pay-amount').forEach(input => {
                        input.addEventListener('input', function () {
                            const payAmount = parseFloat(input.value || 0);
                            const row = input.closest('tr');
                            const outstandingCost = parseFloat(row.querySelector('.outstanding-cost').textContent.replace(/,/g, ''));

                            // Validate input: if payAmount exceeds outstandingCost, reset the input to max value
                            if (payAmount > outstandingCost) {
                                input.value = outstandingCost.toFixed(2);
                            }

                            // Recalculate and update dueAmount
                            const newDueAmount = (outstandingCost - parseFloat(input.value || 0)).toFixed(2);
                            row.querySelector('.due-amount').textContent = formatIndianCurrency(newDueAmount);
                        });
                    });
                } catch (error) {
                    console.error('Error fetching payment details:', error);
                    alert('Could not load payment details. Please try again.');
                }
            });
        });

        // Handle form submission
        payForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const defaultText = submitBtn.querySelector('.default-text');
            const processingText = submitBtn.querySelector('.processing-text');

            // Disable button and show processing state
            submitBtn.disabled = true;
            defaultText.style.display = 'none';
            processingText.style.display = 'inline';

            const vendorId = vendorIdInput.value;
            const paymentData = Array.from(document.querySelectorAll('.pay-amount')).map(input => ({
                invoice_number: input.getAttribute('data-invoice-number'),
                pay_amount: parseFloat(input.value || 0),
                mode_of_payment: input.closest('tr').querySelector('.mode-of-payment').value,
                date_of_payment: input.closest('tr').querySelector('.date-of-payment').value,
                purchase_date: input.closest('tr').querySelector('.purchase-date').textContent
            }));

            try {
                const response = await fetch('/process_payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor_id: vendorId, payments: paymentData })
                });

                if (!response.ok) throw new Error('Failed to process payments.');
                const responseData = await response.json();

                // Close modal and reload page
                payModal.modal('hide');
                location.reload();
            } catch (error) {
                console.error('Error processing payments:', error);
                alert('Failed to update payments. Please try again.');

                // Re-enable button if there's an error
                submitBtn.disabled = false;
                defaultText.style.display = 'inline';
                processingText.style.display = 'none';
            }
        });
    });
</script>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".currency").forEach(function (element) {
            let amount = parseFloat(element.getAttribute("data-value"));
            element.textContent = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        });
    });
</script>

{% endblock %}
